# Whole retina bulk ATAC-seq experiments in wild-type and CRX HD mutant mouse retinas
This directory contains all scripts and metadata information used to process, analyze, and visualize CRX ATAC-seq data obtained from P14 wild-type and CRX HD mutant mouse retinas. The scripts should be run in the numbered order. Processed data needed to generate manuscript figures are stored under the `processed_data` folder. The raw data and additional processed data can be downloaded from [GEO](link_to_chipseq_GEO). 

## Brief description of the ChIP-seq analysis pipeline
All the analyses were performed on the WashU HTCF using SLURM.
1. **Assessing quality and adpater trimming:** `QC_trimgalore_ATAC.sbatch` performs adapter trimming by `trimgalore/0.6.1` on the raw FASTQ files and runs two quality control checks of the FASTQ files by `fastqc/0.11.7` before and after the trimming. The trimmed fq.gz files will be written to a new folder `./trim`. The output from FastQC will be written to the sub-directory `./trim/fastq_files`.
2. **Alignment to the genome and filtering:** `alignment_bowtie_ATAC.sbatch` aligns trimmed reads to the `mm10` genome by `bowtie2/2.3.5`; filters only uniquely mapped reads by `samtools/1.12` and `picard/2.21.4`; and removes alignments overlapped with blacklisted regions by `bedtools/2.27.1`. The final bam file is written to a new folder `./alignedbam`, sorted and indexed. A text file containing samtools flagstat statistics will be generated for output bam file and written to the sub-directory `./alignedbam/filtering_stats`.
3. **Shift mapped reads:** `fragment_siever_ATAC.sbatch` shifts the mapped ATAC reads by `deeptools/3.5.3`  to account for the transponson insertion sequences. The output bam files will be sorted, indexed, and written to a new folder `./sievedbam`.
4. **Peak calling:** `peakcall_macs2_ATAC.sbatch` performs peak calling by `macs2/2.2.7.1` on the clean alignment files. The macs2 output files will be written to a new folder `./macs2peak` with each sample in their seperate sub-directory.
5. **Visualization of peaks:** `bamtoBigWig_deeptools_ATAC.sbatch` converts alignement files (BAM) to bigWig files. The output bigWig files will be written to a new folder `./bigwigs`.
   - `genoAvgBigWig_deeptools_ATAC.sbatch` generate genotype avergae bigWig files using `DiffBind\3.0.15`. The output bigWig files will be written to the folder `./bigwigs`.
   - `plotMx_deeptools_ATAC.sbatch` takes lists of bigWig files and bed files, generates coverage matrix, and makes coverage heatmaps using `deeptools/3.5.3`. The coverage matrix and heatmaps will be written to another new folder `./deeptools`.
6. **Differential enrichement analysis:** `quantification_DiffBind_ATAC.sbatch` is a wrapper script to run the three R scripts.
   - `fragment_size_distri.R` performs differential binding analysis with Rconductor package `ATACseqQC\???`. The fragment size distribution plots and text files are written to folder `./DiffBind/outputs/fragmentDistribution`.
   - `analyze_diffpeak_atac.R` performs differential binding analysis with R Bioconductor package `DiffBind\3.0.15`. The post-analysis DBA object will be stored in RData format under folder `./DiffBind/outputs`. A detailed description of the DiffBind pipeline can be found [here](https://hbctraining.github.io/Intro-to-ChIPseq/lessons/08_diffbind_differential_peaks.html). The normalized count matrix and differential analysis matrix were extracted from the DBA object, compiled, and written to the `./processed_data` folder.
   - `retrieve_matrix_atac.ipynb` retrieves the consensus peakset and differential analysis matrices from the DBA object generated in the step above. 
   - `coordinate_to_fasta.R` takes a list of mm10 genome coordinates in the bed format and fetches the DNA sequences. The FASTA files will be written to the specified output .fa file.
   - `great_analysis_fromBED.R` submits a set of coordinates for [Genomic Regions Enrichment of Annotations Tool (GREAT) analysis](http://great.stanford.edu/public/html/splash.php) and retrieves results from the GREAT web server through R package [rGREAT\1.19.2](https://bioconductor.org/packages/release/bioc/vignettes/rGREAT/inst/doc/rGREAT.html). The GREAT analysis results were extracted and written to the specified output .tsv and .rds files.
7. **Genomic environment annotation:** `annotation_homer_ATAC.sbatch` annotates a list of genome coordinates in the bed format by `homer/4.11` annotatePeaks.pl function. The output bed file will be written to the same folder as the input bed file.
8. **_De novo_ motif discovery:**  `meme_denovo_searching_ATAC.sbatch` performs motif analysis with the `meme/5.5.2` on FASTA files. The output files will be written to a new folder `./meme` with each sample in a separate sub-directory.
9. **FIMO motif scanning:**  `meme_fimo_scanning_ATAC.sbatch` scans a list of fasta sequences with user specified pwm models with FIMO in the MEME suite `meme/5.5.2`. The output files will be written to a new folder `./fimo` with each sample in a separate sub-directory. The PWM models used are compiled in `atacPhotoreceptorMotif.meme` under the `./processed_data` folder.

## Metadata files
- `bowtie_meta.txt` lists all ATAC samples.
- `diffbind_meta.sieved.e80a.txt` is the experimental sample sheet used to construct the DBA object for E80A ATAC differential binding analysis.
- `diffbind_meta.sieved.k88n.txt` is the experimental sample sheet used to construct the DBA object for K88N ATAC differential binding analysis.
- `meme_fasta_meta.txt` lists the identifiers for FASTA files to be submitted to de novo motif analysis.